<div class="content-container p-6 bg-white shadow-md rounded-lg">
  <h1 class="text-2xl font-bold mb-4">New Order</h1>

  <%= form_with(model: @order, url: orders_path, local: true) do |f| %>
    
    <% if flash[:alert].present? %>
      <p class="text-red-500 mb-4"><%= flash[:alert] %></p>
    <% end %>

    <div>
      <%= f.hidden_field :store_id, value: @store.id %>
    </div>

    <% if current_user.admin? %>
      <div class="mb-4">
        <%= f.label :buyer_id, "Select Buyer", class: "block font-bold mb-1" %>
        <%= f.collection_select :buyer_id, @buyers, :id, :email, { prompt: "Choose a Buyer" }, class: "form-select mt-1 block w-full" %>
      </div>
    <% end %>

    <div id="order_items" class="mb-4">
      <h3 class="text-xl font-semibold mb-2">Cart</h3>
      <% @order.order_items.each_with_index do |item, index| %>
        <div class="order_item mb-4 p-4 border rounded-lg">
          <%= f.fields_for "order_items[]", item do |item_fields| %>
            <%= item_fields.hidden_field :id %>
            <div class="mb-2">
              <%= item_fields.label :product_id, "Product", class: "block font-bold mb-1" %>
              <%= item_fields.collection_select :product_id, @products, :id, :title, { prompt: "Choose a Product" }, class: "form-select mt-1 block w-full" %>
            </div>
            <div class="mb-2">
              <%= item_fields.label :amount, "Amount", class: "block font-bold mb-1" %>
              <%= item_fields.number_field :amount, min: 1, class: "form-input mt-1 block w-full" %>
            </div>
          <% end %>
        </div>
      <% end %>
    </div>

    <div class="mb-4">
      <button type="button" id="add-item-button" class="btn-form">Add Another Product</button>
    </div>

    <div>
      <%= f.submit "Create Order", class: "btn-form" %>
    </div>
  <% end %>
</div>





<script>
  function addProductItem() {
    let orderItemsDiv = document.getElementById('order_items');
    if (!orderItemsDiv) return;

    let newItem = document.createElement('div');
    newItem.classList.add('order_item');

    let timestamp = new Date().getTime();

    newItem.innerHTML = `
      <label for="order_order_items_${timestamp}_product_id">Product</label>
      <select name="order[order_items][][product_id]" id="order_order_items_${timestamp}_product_id">
        <option value="">Choose a Product</option>
        <% @products.each do |product| %>
          <option value="<%= product.id %>"><%= product.title %></option>
        <% end %>
      </select>
      <label for="order_order_items_${timestamp}_amount">Amount</label>
      <input type="number" name="order[order_items][][amount]" id="order_order_items_${timestamp}_amount" min="1" />
    `;

    orderItemsDiv.appendChild(newItem);
  }

  function setupAddItemButton() {
    let addItemButton = document.getElementById('add-item-button');
    if (addItemButton) {
      addItemButton.addEventListener('click', addProductItem);
    }
  }

  document.addEventListener('turbo:load', function() {
    console.log("turbo:load event fired");
    setupAddItemButton();
  });
</script>